<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>คลังความรู้</title> <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anuphan:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Thai:wght@400;700&display=swap" rel="stylesheet">


    <style>
        body {
            font-family: 'Anuphan', sans-serif; /* Use Anuphan as the base font */
            background-color: #f4f7f6;
            margin: 0;
            padding: 0;
             /* Base text color for the body, will be overridden in main content */
            color: #1f2937; /* Dark gray for general text */
        }
        .password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
             color: #1f2937; /* Ensure password overlay text is readable */
        }
        .password-input-container {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        .password-input {
            width: 40px;
            height: 40px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1.2rem;
            outline: none;
        }
        .password-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .error-message {
            color: #ef4444;
            margin-top: 10px;
        }

        /* Styles for the main content area */
        #mainContent {
             color: #0a2342; /* Dark blue theme color for main text */
        }

        .header-container {
             display: flex;
             align-items: center;
             justify-content: center; /* Center content horizontally */
             margin-bottom: 20px;
             gap: 10px; /* Space between logo and title */
        }

        .site-logo {
             height: 50px; /* Adjust height as needed */
             width: auto;
        }


        .card {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 16px;
            transition: transform 0.2s ease-in-out;
            display: flex; /* Use flexbox for internal layout */
            flex-direction: column;
            justify-content: space-between; /* Push content apart */
            width: 420px; /* Fixed width as requested */
            box-sizing: border-box; /* Include padding in width */
        }
        .card:hover {
            transform: translateY(-3px);
        }
        .card-header {
            display: flex; /* Use flex to align title and possibly other elements if added */
            align-items: center; /* Vertically center items */
            margin-bottom: 8px;
        }
        .card-title {
            font-family: 'Noto Serif Thai', serif; /* Use Noto Serif Thai for the title */
            font-weight: bold;
            font-size: 1.5rem; /* Increased font size */
            flex-grow: 1; /* Allow title to take space */
            white-space: nowrap; /* Keep title on a single line */
            overflow: hidden; /* Hide overflow */
            text-overflow: ellipsis; /* Add ellipsis for overflow */
            text-align: center; /* Center the project name */
            cursor: pointer; /* Indicate it's clickable */
            text-decoration: none; /* Remove default link underline */
            display: block; /* Make it a block element to take full width */
            padding: 10px 16px; /* Increased padding for button feel */
            color: white; /* White text */
            border-radius: 8px; /* Rounded corners */
            transition: background-color 0.2s ease;
            width: 100%; /* Make the button full width */
            box-sizing: border-box; /* Include padding in width */
        }
         .card-title:hover {
             text-decoration: none; /* Ensure no underline on hover for button style */
         }
        .card-icons {
           display: none; /* Hide the original icons container */
        }
        .card-meta {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 8px; /* Add space below meta */
            font-size: 0.8rem; /* Adjusted font size */
            color: #6b7280; /* Keep meta info color subtle */
            gap: 8px; /* Space between meta items */
        }
        .card-tag {
            display: inline-block;
            background-color: #e0e7ff;
            color: #4338ca;
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 9999px;
            /* margin-right: 8px; Removed, using gap in meta */
            margin-bottom: 0; /* Removed, using gap in meta */
        }
         .card-status {
            display: inline-block;
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 9999px;
            /* margin-right: 8px; Removed, using gap in meta */
            margin-bottom: 0; /* Removed, using gap in meta */
            font-weight: bold;
        }
         .card-action-icons {
             display: flex;
             align-items: center;
             gap: 8px; /* Space between action icons */
             margin-left: auto; /* Push action icons and timestamp to the right */
         }
         .card-action-icons i {
             cursor: pointer;
             color: #6b7280; /* Keep icon color subtle */
             transition: color 0.2s ease-in-out;
         }
         .card-action-icons i:hover {
             color: #3b82f6;
         }
         .card-database-icon {
             /* Styles moved to .card-action-icons i */
             color: #3b82f6; /* Blue color for the database icon */
         }
         .card-timestamp {
             /* margin-left: auto; Removed, now part of card-action-icons flex */
             font-size: 0.7rem;
             color: #9ca3af; /* Keep timestamp color subtle */
         }
        .card-description {
            font-size: 0.9rem;
            font-weight: 300; /* Anuphan Light */
            margin-bottom: 12px;
            flex-grow: 1; /* Allow description to take space */
            text-indent: 1em; /* Add indent to the first line */

            /* Button-like styling for description */
            padding: 10px 12px; /* Add padding */
            border-radius: 8px; /* Rounded corners */
            border: 1px solid transparent; /* Default transparent border */
        }
        .card-links {
            display: none; /* Hide the link buttons section */
        }

        /* Status Theme Classes */
        /* In Process (กำลังดำเนินการ) - Orange Theme */
        .status-theme-in-process .card-title {
            background-color: #f59e0b; /* Amber 500 */
        }
         .status-theme-in-process .card-title:hover {
            background-color: #d97706; /* Amber 600 */
        }
        .status-theme-in-process .card-description {
            background-color: #fffbe0; /* Amber 50 */
            border-color: #fde68a; /* Amber 200 */
             color: #b45309; /* Amber 700 */
        }

        /* Completed (พร้อมใช้งาน) - Dark Green Theme */
        .status-theme-completed .card-title {
            background-color: #047857; /* Green 700 */
        }
         .status-theme-completed .card-title:hover {
            background-color: #064e3b; /* Green 800 */
        }
        .status-theme-completed .card-description {
            background-color: #d1fae5; /* Green 50 */
            border-color: #a7f3d0; /* Green 200 */
             color: #065f46; /* Green 700 */
        }

        /* Inactive (ระงับชั่วคราว) - Gray Theme */
        .status-theme-inactive .card-title {
            background-color: #6b7280; /* Gray 500 */
        }
         .status-theme-inactive .card-title:hover {
            background-color: #4b5563; /* Gray 600 */
        }
        .status-theme-inactive .card-description {
            background-color: #e5e7eb; /* Gray 100 */
            border-color: #d1d5db; /* Gray 200 */
             color: #374151; /* Gray 700 */
        }


        .floating-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: #3b82f6;
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: background-color 0.3s ease;
            z-index: 999;
        }
        .floating-button:hover {
            background-color: #2563eb;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            max-height: 90vh; /* Limit height */
            overflow-y: auto; /* Add scroll if needed */
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .modal-close {
            cursor: pointer;
            font-size: 1.5rem;
            color: #6b7280;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #374151;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            box-sizing: border-box; /* Include padding in element's total width and height */
        }
         .form-group textarea {
             min-height: 80px;
             resize: vertical;
         }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 20px;
        }
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            border: none;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
            border: none;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .filter-bar {
            background-color: #ffffff;
            padding: 16px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .filter-group {
            display: flex;
            gap: 16px;
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }
        .filter-group input,
        .filter-group select {
             flex-grow: 1; /* Allow inputs to grow */
             min-width: 150px; /* Minimum width before wrapping */
             padding: 10px;
             border: 1px solid #d1d5db;
             border-radius: 8px;
             font-size: 1rem;
             outline: none;
        }
         .filter-group input:focus,
         .filter-group select:focus {
             border-color: #3b82f6;
             box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
         /* Style for the new tag filter dropdown */
         #filterTag {
             /* Inherits styles from filter-group select */
         }

        .tag-section {
            margin-bottom: 30px;
        }
        .tag-section h3 {
            font-size: 1.3rem;
            font-weight: bold;
            color: #1f2937; /* Keep tag header color distinct */
            margin-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 5px;
        }
        .links-grid {
            display: grid;
            /* Adjust grid columns for ~4 per row on larger screens, responsive */
            grid-template-columns: repeat(auto-fit, minmax(420px, 1fr)); /* Use auto-fit and fixed 420px */
            gap: 20px; /* Space between grid items */
             justify-content: center; /* Center the grid items */
        }
        .no-links {
            text-align: center;
            color: #6b7280;
            margin-top: 30px;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1001; /* Higher than modal */
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
         .loading-text {
             color: #374151;
             font-weight: 500;
         }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div id="passwordOverlay" class="password-overlay">
        <div class="password-input-container" id="passwordInputContainer">
            <input type="password" class="password-input" maxlength="1" data-index="0" autocomplete="off">
            <input type="password" class="password-input" maxlength="1" data-index="1" autocomplete="off">
            <input type="password" class="password-input" maxlength="1" data-index="2" autocomplete="off">
            <input type="password" class="password-input" maxlength="1" data-index="3" autocomplete="off">
        </div>
        <div id="passwordError" class="error-message"></div>
    </div>

    <div id="mainContent" class="container mx-auto p-4 hidden">
         <div class="header-container">
             <img src="https://i.postimg.cc/xf6MDW3D/logo.png?dl=1" alt="Site Logo" class="site-logo"> <h1 class="text-3xl font-bold text-center text-gray-800">คลังความรู้</h1> </div>


        <div class="filter-bar">
            <div class="filter-group">
                <input type="text" id="filterName" placeholder="Filter by Name">
                <select id="filterTag">
                    <option value="">All Tags</option>
                    </select>
                 <select id="filterStatus">
                     <option value="">All Statuses</option>
                     <option value="In Process">กำลังดำเนินการ</option> <option value="Completed">พร้อมใช้งาน</option> <option value="Inactive">ระงับชั่วคราว</option> </select>
            </div>
        </div>

        <div id="linksContainer">
            </div>

         <div id="noLinksMessage" class="no-links hidden">
             No links found matching your criteria.
         </div>
    </div>

    <div id="addButton" class="floating-button hidden">+</div>

    <div id="linkModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add New Link</h2>
                <span class="modal-close" id="closeModal">&times;</span>
            </div>
            <form id="linkForm">
                <input type="hidden" id="linkId">
                <div class="form-group">
                    <label for="projectName">Project Name:</label>
                    <input type="text" id="projectName" required>
                </div>
                <div class="form-group">
                    <label for="tag">Tag:</label>
                    <input type="text" id="tag" required>
                </div>
                 <div class="form-group">
                    <label for="status">Status:</label>
                    <select id="status" required>
                         <option value="In Process">กำลังดำเนินการ</option> <option value="Completed">พร้อมใช้งาน</option> <option value="Inactive">ระงับชั่วคราว</option> </select>
                </div>
                <div class="form-group">
                    <label for="description">Description:</label>
                    <textarea id="description"></textarea>
                </div>
                <div class="form-group">
                    <label for="databaseURL">Database URL:</label>
                    <input type="url" id="databaseURL">
                </div>
                 <div class="form-group">
                    <label for="projectURL">Project URL:</label>
                    <input type="url" id="projectURL" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" id="cancelModal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Link</button>
                </div>
            </form>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>


    <script>
        // !! IMPORTANT: Replace with your deployed Google Apps Script Web App URL !!
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzlxCCosbo_kT4-sFNiJq549clOLECsU_GXN_2BUcfyCI5inkjNKA6KwrhOPyzAzWsi/exec'; // e.g., 'https://script.google.com/macros/s/AKfycb.../exec'

        const passwordOverlay = document.getElementById('passwordOverlay');
        const passwordInputContainer = document.getElementById('passwordInputContainer');
        const passwordInputs = passwordInputContainer.querySelectorAll('.password-input');
        const passwordError = document.getElementById('passwordError');
        const mainContent = document.getElementById('mainContent');
        const linksContainer = document.getElementById('linksContainer');
        const addButton = document.getElementById('addButton');
        const linkModal = document.getElementById('linkModal');
        const modalTitle = document.getElementById('modalTitle');
        const closeModal = document.getElementById('closeModal');
        const cancelModal = document.getElementById('cancelModal');
        const linkForm = document.getElementById('linkForm');
        const linkIdInput = document.getElementById('linkId');
        const projectNameInput = document.getElementById('projectName');
        const tagInput = document.getElementById('tag');
        const statusInput = document.getElementById('status');
        const descriptionInput = document.getElementById('description');
        const databaseURLInput = document.getElementById('databaseURL'); // New input
        const projectURLInput = document.getElementById('projectURL');   // New input
        const filterNameInput = document.getElementById('filterName');
        const filterTagSelect = document.getElementById('filterTag'); // Changed to select
        const filterStatusInput = document.getElementById('filterStatus');
        const loadingOverlay = document.getElementById('loadingOverlay'); // Loading overlay element
        const noLinksMessage = document.getElementById('noLinksMessage');


        let allLinks = []; // Store all fetched links

        // --- Password Handling ---
        passwordInputs.forEach(input => {
            input.addEventListener('input', handlePasswordInput);
            input.addEventListener('keydown', handlePasswordKeydown);
            input.addEventListener('focus', handlePasswordFocus);
        });

         // Focus the first input on load
        passwordInputs[0].focus();


        function handlePasswordInput(event) {
            const input = event.target;
            const index = parseInt(input.dataset.index);
            const value = input.value;

            if (value.length === 1) {
                if (index < passwordInputs.length - 1) {
                    passwordInputs[index + 1].focus();
                }
            }

            checkPassword();
        }

         function handlePasswordKeydown(event) {
             const input = event.target;
             const index = parseInt(input.dataset.index);

             // Handle backspace
             if (event.key === 'Backspace' && input.value === '') {
                 if (index > 0) {
                     passwordInputs[index - 1].focus();
                 }
             }
         }

         function handlePasswordFocus(event) {
             // Select the content when focused, useful for correction
             event.target.select();
         }


        function checkPassword() {
            const enteredPassword = Array.from(passwordInputs).map(input => input.value).join('');
            if (enteredPassword.length === passwordInputs.length) {
                // Password entered, attempt login
                passwordError.textContent = ''; // Clear previous errors
                fetchLinks(enteredPassword); // Attempt to fetch links with the password
            }
        }

        // --- API Interaction ---

        async function fetchData(action, data = {}) {
            const webAppUrl = WEB_APP_URL; // Use the global URL

            // Add the password to every request
            const enteredPassword = Array.from(passwordInputs).map(input => input.value).join('');
            data.password = enteredPassword;
            data.action = action;

            const formBody = new URLSearchParams(data).toString();

            console.log(`Sending request: Action=${action}, Data=`, data); // Log outgoing request

            try {
                 loadingOverlay.classList.remove('hidden'); // Show loading overlay
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: formBody,
                    mode: 'cors' // Required for cross-origin requests
                });

                 if (!response.ok) {
                     const errorText = await response.text();
                     console.error(`HTTP error! status: ${response.status}`, errorText); // Log HTTP error details
                     throw new Error(`HTTP error! status: ${response.status}`);
                 }

                const result = await response.json();
                console.log('Received response:', result); // Log received response
                return result;

            } catch (error) {
                console.error('Error fetching data:', error);
                // Display error message to the user (e.g., in a dedicated error area)
                alert('An error occurred: ' + error.message); // Basic alert for now
                return { status: 'error', message: 'Failed to connect or process data.' };
            } finally {
                 loadingOverlay.classList.add('hidden'); // Hide loading overlay regardless of success/failure
            }
        }

        async function fetchLinks(password) {
            const result = await fetchData('getLinks', { password: password });

            if (result.status === 'success') {
                allLinks = result.data;
                populateTagFilter(allLinks); // Populate tag filter after fetching
                displayLinks(allLinks);
                passwordOverlay.classList.add('hidden'); // Hide password screen
                mainContent.classList.remove('hidden'); // Show main content
                addButton.classList.remove('hidden'); // Show add button
            } else {
                passwordError.textContent = result.message || 'Incorrect password.';
                 // Clear password inputs
                 passwordInputs.forEach(input => input.value = '');
                 passwordInputs[0].focus();
            }
        }

        async function addLinkToSheet(linkData) {
            const result = await fetchData('addLink', linkData);
            if (result.status === 'success') {
                 // Fetch updated links after adding
                 fetchLinks(Array.from(passwordInputs).map(input => input.value).join(''));
                 hideModal();
            } else {
                alert('Failed to add link: ' + result.message);
            }
        }

         async function editLinkInSheet(linkData) {
             const result = await fetchData('editLink', linkData);
             if (result.status === 'success') {
                 // Fetch updated links after editing
                 fetchLinks(Array.from(passwordInputs).map(input => input.value).join(''));
                 hideModal();
             } else {
                 alert('Failed to edit link: ' + result.message);
             }
         }

         async function deleteLinkFromSheet(linkId) {
             if (confirm('Are you sure you want to delete this link?')) {
                 const result = await fetchData('deleteLink', { id: linkId });
                 if (result.status === 'success') {
                     // Fetch updated links after deleting
                     fetchLinks(Array.from(passwordInputs).map(input => input.value).join(''));
                 } else {
                     alert('Failed to delete link: ' + result.message);
                 }
             }
         }


        // --- Display and Filtering ---

        function populateTagFilter(links) {
            const tags = new Set();
            links.forEach(link => {
                if (link.Tag) {
                    tags.add(link.Tag);
                }
            });

            // Clear existing options except the default
            filterTagSelect.innerHTML = '<option value="">All Tags</option>';

            // Add unique tags
            Array.from(tags).sort().forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                option.textContent = tag;
                filterTagSelect.appendChild(option);
            });
        }


        function displayLinks(linksToDisplay) {
            linksContainer.innerHTML = ''; // Clear current links

            if (linksToDisplay.length === 0) {
                 noLinksMessage.classList.remove('hidden');
                 return;
            } else {
                 noLinksMessage.classList.add('hidden');
            }

            // Group links by tag
            const linksByTag = linksToDisplay.reduce((acc, link) => {
                const tag = link.Tag || 'Untagged';
                if (!acc[tag]) {
                    acc[tag] = [];
                }
                acc[tag].push(link);
                return acc;
            }, {});

            // Sort tags alphabetically
            const sortedTags = Object.keys(linksByTag).sort();

            sortedTags.forEach(tag => {
                const tagSection = document.createElement('div');
                tagSection.classList.add('tag-section');

                const tagHeader = document.createElement('h3');
                tagHeader.textContent = tag;
                tagSection.appendChild(tagHeader);

                // Create a grid container for links within this tag
                const linksGrid = document.createElement('div');
                linksGrid.classList.add('links-grid');

                // Sort links within each tag by timestamp (most recent first)
                linksByTag[tag].sort((a, b) => {
                    const dateA = new Date(a.Timestamp);
                    const dateB = new Date(b.Timestamp);
                    return dateB - dateA; // Descending order
                });


                linksByTag[tag].forEach(link => {
                    const card = createLinkCard(link);
                    linksGrid.appendChild(card);
                });

                tagSection.appendChild(linksGrid); // Add the grid to the section
                linksContainer.appendChild(tagSection);
            });
        }

        function createLinkCard(link) {
            const card = document.createElement('div');
            card.classList.add('card');
            card.dataset.id = link.ID; // Store ID on the card element

            // Determine status class for theme
            const statusThemeClass = link.Status ? `status-theme-${link.Status.toLowerCase().replace(/\s+/g, '-')}` : '';
            card.classList.add(statusThemeClass); // Add status theme class to the card

            const statusClass = link.Status ? `status-${link.Status.toLowerCase().replace(/\s+/g, '-')}` : '';
             const timestamp = link.Timestamp ? new Date(link.Timestamp).toLocaleString() : 'N/A';

            // Map English status to Thai for display
            const thaiStatus = {
                'In Process': 'กำลังดำเนินการ',
                'Completed': 'พร้อมใช้งาน',
                'Inactive': 'ระงับชั่วคราว'
            }[link.Status] || link.Status || '';


            card.innerHTML = `
                 <div class="card-meta">
                    ${link.Tag ? `<span class="card-tag">${link.Tag}</span>` : ''}
                    ${link.Status ? `<span class="card-status ${statusClass}">${thaiStatus}</span>` : ''} <div class="card-action-icons">
                        ${link['Database URL'] ? `<i class="fas fa-database card-database-icon" data-url="${link['Database URL']}"></i>` : ''}
                        <i class="fas fa-pen edit-icon" data-id="${link.ID}"></i>
                        <i class="fas fa-trash-can delete-icon" data-id="${link.ID}"></i>
                     </div>
                    <span class="card-timestamp">${timestamp}</span>
                 </div>
                <div class="card-header">
                    <a href="${link['Project URL']}" class="card-title" target="_blank">${link['Project Name']}</a>
                </div>
                <div class="card-description">${link.Description || 'No description.'}</div>
                <div class="card-links">
                    </div>
            `;

            // Add event listeners for edit and delete icons
            card.querySelector('.edit-icon').addEventListener('click', handleEditClick);
            // Corrected selector for delete icon
            const deleteIcon = card.querySelector('.fa-trash-can');
            if (deleteIcon) {
                deleteIcon.addEventListener('click', handleDeleteClick);
            }


             // Add event listener for the database icon
             const dbIcon = card.querySelector('.card-database-icon');
             if (dbIcon) {
                 dbIcon.addEventListener('click', handleDatabaseIconClick);
             }


            return card;
        }

        // Handler for the database icon click
        function handleDatabaseIconClick(event) {
            const url = event.target.dataset.url;
            if (url) {
                window.open(url, '_blank'); // Open the URL in a new tab
            }
        }


        function filterLinks() {
            const filterName = filterNameInput.value.toLowerCase();
            const filterTag = filterTagSelect.value.toLowerCase(); // Read from select
            const filterStatus = filterStatusInput.value.toLowerCase();

            const filtered = allLinks.filter(link => {
                const matchesName = link['Project Name'].toLowerCase().includes(filterName);
                const matchesTag = filterTag === '' || (link.Tag && link.Tag.toLowerCase() === filterTag); // Handle 'All Tags'
                const matchesStatus = filterStatus === '' || (link.Status && link.Status.toLowerCase() === filterStatus);

                return matchesName && matchesTag && matchesStatus;
            });

            displayLinks(filtered);
        }

        filterNameInput.addEventListener('input', filterLinks);
        filterTagSelect.addEventListener('change', filterLinks); // Listen for change on select
        filterStatusInput.addEventListener('change', filterLinks);


        // --- Modal Handling ---

        function showModal(type, link = null) {
            linkForm.reset(); // Clear form
            linkIdInput.value = ''; // Clear ID

            if (type === 'add') {
                modalTitle.textContent = 'Add New Link';
                 // Set default status for new links
                 statusInput.value = 'In Process'; // Default to In Process
            } else if (type === 'edit' && link) {
                modalTitle.textContent = 'Edit Link';
                linkIdInput.value = link.ID;
                projectNameInput.value = link['Project Name']; // Ensure this is correctly populated
                tagInput.value = link.Tag;
                statusInput.value = link.Status || 'In Process'; // Default to In Process if status is empty
                descriptionInput.value = link.Description;
                databaseURLInput.value = link['Database URL'] || ''; // Populate new fields
                projectURLInput.value = link['Project URL'] || '';   // Populate new fields
            }

            linkModal.classList.remove('hidden');
        }

        function hideModal() {
            linkModal.classList.add('hidden');
        }

        addButton.addEventListener('click', () => showModal('add'));
        closeModal.addEventListener('click', hideModal);
        cancelModal.addEventListener('click', hideModal);

        linkForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            const linkData = {
                projectName: projectNameInput.value, // Ensure this value is captured
                tag: tagInput.value,
                status: statusInput.value,
                description: descriptionInput.value,
                databaseURL: databaseURLInput.value, // Include new fields
                projectURL: projectURLInput.value    // Include new fields
            };

            if (linkIdInput.value) {
                // Editing existing link
                linkData.id = linkIdInput.value;
                await editLinkInSheet(linkData);
            } else {
                // Adding new link
                await addLinkToSheet(linkData);
            }
        });

        // --- Edit and Delete Handlers ---

        function handleEditClick(event) {
            const linkId = event.target.dataset.id;
            const linkToEdit = allLinks.find(link => String(link.ID) === String(linkId));
            if (linkToEdit) {
                showModal('edit', linkToEdit);
            } else {
                alert('Link not found for editing.');
            }
        }

        function handleDeleteClick(event) {
            const linkId = event.target.dataset.id;
            deleteLinkFromSheet(linkId);
        }

        // --- Initial Load ---
        // Password check happens automatically when inputs are filled
    </script>

</body>
</html>
